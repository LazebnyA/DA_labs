Лабораторна робота №4. Код

```{r}
library(tidyverse)
library(locfit)
library(np)
library(MASS)
library(ggplot2)
library(factoextra)

```


```{r}
# 
# 
# Зчитування даних з файлу
diabetes_data <- read_csv("./prepared_data.csv")

# Категоріальні змінні
gen.hlth_categories <- c("excellent", "very good", "good", "fair", "poor")
age_categories <- c("18-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80+")
edc_categories <- c("No education", "Elementary", "Some high school", "High school graduate", "Some college or tech. school", "College graduate")
income_categories <- c("Less than $10,000", "$10,000-$15,000", "$15,000-$20,000", "$20,000-$25,000", "$25,000-$35,000", "$35,000-$50,000", "$50,000-$75,000", "$75,000 or more")

# Обробка даних
diabetes_data <- diabetes_data %>%
   mutate(across(c("HighBP", "HighChol", "CholCheck", "Smoker", "Stroke", "HeartDiseaseorAttack", "PhysActivity", "Fruits", "Veggies", "HvyAlcoholConsump", "AnyHealthcare", "NoDocbcCost", "DiffWalk"), as.factor),
         Diabetes = as.numeric(Diabetes),
         GenHlth = factor(GenHlth, levels = gen.hlth_categories),
         Age = factor(Age, levels = age_categories),
         Education = factor(Education, levels = edc_categories),
         Income = factor(Income, levels = income_categories),
         Sex = factor(Sex, levels = c("female", "male")),
         log_BMI = log(BMI))


str(diabetes_data, give.attr = FALSE, show_col_types = FALSE)
summary(diabetes_data)

```



Регресори, які потрібно оцінити непараметрично
Фактично, це всі неперервні змінні, тобто BMI (log_BMI), MentHlth, PhysHlth

Регресори, які потрібно оцінити параметрично (за допомогою часткової лінійної регресії)
Всі інші регресори, які мали місце в фінальній моделі з лабораторної роботи №3.




1. Проводимо крос-валідацію, щоб знайти оптимальне значення параметру h.


Будуємо початкову модель

```{r}

# Fit the locfit model
nl_logit_model <- locfit(Diabetes ~ lp(log_BMI), 
                         data = diabetes_data, family = "binomial")

print(nl_logit_model)

```



Знаходимо оптимальне h за допомогою крос-валідації.

```{r}

lscv(~lp(diabetes_data$log_BMI,h=1,deg=0), ev=lfgrid(100,ll=1,ur=6), kern="gauss")
lscv.exact(lp(diabetes_data$log_BMI,h=0.25))

```

Будуємо графіки передбачень. Додаємо інші неперервні регресори.

```{r}

x_grid <- seq(min(diabetes_data$log_BMI), max(diabetes_data$log_BMI), by = 0.001)
predicted_prob <- predict(nl_logit_model, newdata = data.frame(log_BMI = x_grid), type = "response")

diabetes_freq <- diabetes_data %>%
  group_by(log_BMI) %>%
  summarise(diabetes_rate = mean(as.numeric(Diabetes)))

ggplot() +
  geom_point(data = diabetes_freq, aes(x = log_BMI, y = diabetes_rate), size = 1, color = "blue", alpha = 0.5) +
  geom_line(data = data.frame(log_BMI = x_grid, predicted_prob = predicted_prob), aes(x = log_BMI, y = predicted_prob), color = "red") +
  labs(title = "Діаграма відносної частоти діабету (ймовірності діабету) та не параметричної логістичної регресії. (Регресор - log_BMI, всі інші зафіксовані)",
       x = "Логарифм ІМТ",
       y = "Відносна частота діабету") +
  theme_minimal()

```


```{r}

diabetes_data <- diabetes_data %>%
  mutate(log_MentHlth = log(MentHlth + 1),  # Add 1 to avoid log(0)
         log_PhysHlth = log(PhysHlth + 1))  # Add 1 to avoid log(0)

# Fit the locfit model
nl_control_model <- locfit(Diabetes ~ lp(log_BMI) + lp(log_MentHlth) + lp(log_PhysHlth), 
                         data = diabetes_data, family = "binomial")

print(nl_logit_model)

```


```{r}

x_grid <- seq(min(diabetes_data$log_BMI), max(diabetes_data$log_BMI), by = 0.001)
predicted_prob <- predict(nl_control_model, newdata = data.frame(log_BMI = x_grid, log_MentHlth=median(diabetes_data$log_MentHlth),
                                                               log_PhysHlth=median(diabetes_data$log_PhysHlth)), type = "response")

diabetes_freq <- diabetes_data %>%
  group_by(log_BMI) %>%
  summarise(diabetes_rate = mean(as.numeric(Diabetes)))

ggplot() +
  geom_point(data = diabetes_freq, aes(x = log_BMI, y = diabetes_rate), size = 1, color = "blue", alpha = 0.5) +
  geom_line(data = data.frame(log_BMI = x_grid, predicted_prob = predicted_prob), aes(x = log_BMI, y = predicted_prob), color = "red") +
  labs(title = "Діаграма відносної частоти діабету (ймовірності діабету) та не параметричної логістичної регресії. (Регресор - log_BMI, всі інші зафіксовані)",
       x = "Логарифм ІМТ",
       y = "Відносна частота діабету") +
  theme_minimal()

```

Source

locfit - https://cran.r-project.org/web/packages/locfit/locfit.pdf#page=35.08
locfit raw - https://cran.r-project.org/web/packages/locfit/locfit.pdf#page=38.14

